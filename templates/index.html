<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Geocoding Finder</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>

  <div class="container">
    <header class="header">
      <h1>ğŸŒ Cari Lokasi di Google Maps</h1>
      <div class="team-info">
        <span>By <a href="#" target="_blank" class="team-link">HICT Team</a></span>
        <br>
        <small><a href="https://cicdtes-169926749078.asia-southeast2.run.app/" target="_blank" class="view-team">Lihat Tim Kami â†’</a></small>
      </div>
    </header>

    <!-- FORM CARI MANUAL -->
    <form action="/geocode" method="POST" class="search-form">
      <input type="text" name="location" placeholder="Masukkan nama lokasi (cth: Sopodel Tower)" required>
      <button type="submit">Cari</button>
    </form>

    <!-- TOMBOL TEMUKAN LOKASI SAYA -->
    <div class="find-me-section">
      <button onclick="findMyLocation()" class="find-me-button">ğŸ“ Temukan Lokasi Saya</button>
    </div>

    <!-- HASIL LOKASI -->
    {% if lat and lng %}
    <div class="location-card fade-in">
      <h2>Lokasi Ditemukan ğŸ¯</h2>
      <p><strong>Lokasi:</strong> {{ location }}</p>
      <p><strong>Alamat Lengkap:</strong> {{ address }}</p> 
      <p><strong>Latitude:</strong> {{ lat }}</p>
      <p><strong>Longitude:</strong> {{ lng }}</p>
      <div class="map-container">
        <iframe
          width="100%"
          height="300"
          frameborder="0"
          style="border:0; border-radius: 12px; margin-top: 15px;"
          referrerpolicy="no-referrer-when-downgrade"
          src="https://www.google.com/maps/embed/v1/view?key=AIzaSyA-5lk-kJqUDgv7ROiJq3Fc6Nra5GeVR8E&center={{ lat }},{{ lng }}&zoom=16&maptype=roadmap"
          allowfullscreen>
        </iframe>
      </div>
      
      <p>
        <a class="maps-button" href="https://www.google.com/maps?q={{ lat }},{{ lng }}" target="_blank">
          ğŸ“ Lihat di Google Maps
        </a>
      </p>
    </div>
    {% elif error %}
    <div class="error-card fade-in">
      <p>{{ error }}</p>
    </div>
    {% endif %}

    <!-- CARD HASIL DARI TEMUKAN LOKASI -->
    <div id="my-location-card" class="location-card fade-in" style="display: none;">
      <h2>Lokasi Anda Saat Ini ğŸ“</h2>
      <p id="my-address"></p>
      <p id="my-coordinates"></p>
      <div class="map-container">
        <iframe id="my-map"
          width="100%"
          height="300"
          frameborder="0"
          style="border:0; border-radius: 12px; margin-top: 15px;"
          allowfullscreen
          referrerpolicy="no-referrer-when-downgrade">
        </iframe>
      </div>
      <p>
        <a id="my-maps-link" class="maps-button" href="#" target="_blank">
          ğŸ“ Buka di Google Maps
        </a>
      </p>
    </div>

  </div>

  <footer>
    ğŸš€ Dibuat dengan semangat oleh Tim Cloud Multipolar ~ 2025 âœ¨
  </footer>

<script>
  const form = document.querySelector('.search-form');
  const button = form.querySelector('button');

  form.addEventListener('submit', () => {
    button.disabled = true;
    button.innerHTML = `<span class="spinner"></span> Mencari...`;
  });

  function findMyLocation() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(showMyPosition, showError);
    } else {
      alert("Browser Anda tidak mendukung Geolocation.");
    }
  }

  function showMyPosition(position) {
  const lat = position.coords.latitude;
  const lng = position.coords.longitude;
  const embedApiKey = "{{ GOOGLE_API_KEY }}"; // Ambil dari server

  // Tampilkan Card
  document.getElementById('my-location-card').style.display = 'block';

  // Kirim koordinat ke server untuk mendapatkan alamat lengkap
  fetch('/reverse_geocode', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ lat: lat, lng: lng })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Update alamat
      document.getElementById('my-address').innerHTML = `<strong>Alamat Lengkap:</strong> ${data.address}`;
      // Update koordinat
      document.getElementById('my-coordinates').innerHTML = `<strong>Latitude:</strong> ${lat} <br> <strong>Longitude:</strong> ${lng}`;
      // Update iframe map
      document.getElementById('my-map').src = `https://www.google.com/maps/embed/v1/view?key=${embedApiKey}&center=${lat},${lng}&zoom=16&maptype=roadmap`;
      // Update link ke Google Maps
      document.getElementById('my-maps-link').href = `https://www.google.com/maps?q=${lat},${lng}`;
    } else {
      alert("Alamat tidak ditemukan.");
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert("Gagal mendapatkan alamat lengkap.");
  });
}

